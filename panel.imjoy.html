<docs lang="markdown">
The panel for upload the image file.
</docs>

<config lang="json">
{
    "name": "upload-panel",
    "type": "window",
    "tags": [],
    "ui": "",
    "version": "0.1.0",
    "cover": "",
    "description": "[TODO: describe this plugin with one sentence.]",
    "icon": "extension",
    "inputs": null,
    "outputs": null,
    "api_version": "0.1.8",
    "env": "",
    "permissions": [],
    "requirements": [
        "https://cdn.tailwindcss.com",
        "https://cdn.jsdelivr.net/npm/imjoy-rpc@0.5.6/dist/hypha-rpc-websocket.min.js"
    ],
    "dependencies": [
        "http://127.0.0.1:8000/viewer.imjoy.html",
        "http://127.0.0.1:8000/connector.imjoy.html"
    ]
}
</config>

<script lang="javascript">

class ImJoyPlugin {
    async setup() {
        console.log("setup")
        this.connector_plugin = await api.getPlugin('connector')
        this.viewer_plugin = await api.getPlugin('viewer')
        this.setupEvents()
        this.hidenLoadingInfo()
    }

    setupEvents() {
        const showLoadingInfo = this.showLoadingInfo.bind(this)
        const hidenLoadingInfo = this.hidenLoadingInfo.bind(this)
        this.listenFileSelection(showLoadingInfo, hidenLoadingInfo)
        this.listenURLInput(showLoadingInfo, hidenLoadingInfo)
        this.listenSampleInputButton(showLoadingInfo, hidenLoadingInfo)
        this.listenSampleOutputButton(showLoadingInfo, hidenLoadingInfo)
    }

    listenFileSelection(showLoadingInfo, hidenLoadingInfo) {
        const fileInput = document.getElementById("file-input")
        const fileChosen = document.getElementById('file-chosen');
        const viewImageByBytes = this.viewImageByBytes.bind(this)

        fileInput.addEventListener("input", async () => {
            showLoadingInfo()
            const file = fileInput.files[0]
            fileChosen.textContent = file.name
            if (!file) {
                await api.alert("No file selected")
                hidenLoadingInfo()
                return
            }
            const reader = new FileReader()
            reader.onload = async function() {
                const content = this.result
                await viewImageByBytes(file.name, content)
                // set to empty so that the same file can be loaded again
                fileInput.value = ''
                hidenLoadingInfo()()
            }
            reader.readAsArrayBuffer(file)
        })
    }

    listenURLInput(showLoadingInfo, hidenLoadingInfo) {
        const viewImageByURL = this.viewImageByURL.bind(this)
        const urlInput = document.getElementById("url-input")
        const urlLoadButton = document.getElementById("url-load-button")
        urlLoadButton.addEventListener("click", async () => {
            const url = urlInput.value
            if (!url) {
                await api.alert("No URL provided")
                return
            }
            showLoadingInfo()
            await viewImageByURL(url)
            hidenLoadingInfo()
        })
    }

    listenSampleInputButton(showLoadingInfo, hidenLoadingInfo) {
        const sampleInputButton = document.getElementById("sample-input-button")
        sampleInputButton.addEventListener("click", async () => {
            const sampleInput = this.model_rdf.sample_inputs[0]
            showLoadingInfo()
            await this.viewImageByURL(sampleInput)
            hidenLoadingInfo()
        })
    }

    listenSampleOutputButton(showLoadingInfo, hidenLoadingInfo) {
        const sampleOutputButton = document.getElementById("sample-output-button")
        sampleOutputButton.addEventListener("click", async () => {
            const sampleOutput = this.model_rdf.sample_outputs[0]
            showLoadingInfo()
            await this.viewImageByURL(sampleOutput)
            hidenLoadingInfo()
        })
    }

    async viewImageByBytes(fileName, bytes) {
        this.bytes_data = bytes
        console.log(bytes)
        this.viewer_plugin.load_image_from_bytes(fileName, bytes)
    }

    async viewImageByURL(url) {
        this.url = url
        const fileName = url.split("?")[0]
          .replace(/\/$/, '')
          .split("/")
          .pop();

        if (fileName.endsWith(".zarr")) {
            await this.viewer_plugin.show_image_avivator(url)
        } else {
            const bytes = await this.loadBytesFromURL(url)
            this.bytes_data = bytes
            this.viewer_plugin.load_image_from_bytes(fileName, bytes)
        }
    }

    async loadBytesFromURL(url) {
        console.log("loading bytes from url", url)
        const response = await fetch(url)
        const bytes = await response.arrayBuffer()
        console.log(bytes)
        return bytes
    }

    async set_default_url(model_id) {
        const rdf = await this.connector_plugin.get_model_rdf(model_id)
        this.model_rdf = rdf
        console.log(rdf)
        const sampleInput = rdf.sample_inputs[0]
        const urlInput = document.getElementById("url-input")
        urlInput.value = sampleInput
    }

    showLoadingInfo() {
        const loadingInfo = document.getElementById("loading-info")
        loadingInfo.style.display = "block"
    }

    hidenLoadingInfo() {
        const loadingInfo = document.getElementById("loading-info")
        loadingInfo.style.display = "none"
    }

    async run(ctx) {
        console.log("run", ctx)
        const defaultModel = "10.5281/zenodo.5874741"
        const model_id = ctx.data.id || defaultModel
        await this.set_default_url(model_id)
    }
}

api.export(new ImJoyPlugin())
</script>

<window lang="html">
<div class="m-1">
    <p class="mt-4">Load an PNG, JPG or TIFF file:</p>
    <div class="flex">
        <span id="file-chosen" class="w-1/2 px-4 py-2 border border-gray-300 rounded-l-md text-gray-500">No file selected.</span>
        <label for="file-input" class="py-2 px-3 bg-blue-500 text-white rounded-r-md cursor-pointer w-20 text-center">
            Browse
        </label>
        <input type="file" id="file-input" class="hidden" />
    </div>

    <p class="mt-4">Or load from an URL. The URL to OME-Zarr are supported:</p>
    <div class="flex">
        <input type="text" class="w-1/2 px-4 py-2 border border-gray-300 rounded-l-md text-gray-500"
            placeholder="Target URL"
            id="url-input" />
        <button
            class="px-4 py-2 bg-blue-500 text-white rounded-r-md w-20"
            id="url-load-button">Load</button>
    </div>

    <p class="mt-2" id="loading-info">Loading...</p>

    <div class="flex flex-row gap-4 mt-2">
      <button
        class="px-4 py-2 bg-blue-500 text-white rounded-md w-25"
        id="submit-button">Submit</button>
      <button
        class="px-4 py-2 bg-cyan-300 text-white rounded-md w-30"
        id="sample-input-button">Sample input</button>
      <button
        class="px-4 py-2 bg-cyan-300 text-white rounded-md w-30"
        id="sample-output-button">Sample output</button>
    </div>
</div>
</window>
