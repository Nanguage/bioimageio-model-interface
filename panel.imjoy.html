<docs lang="markdown">
The panel for upload the image file.
</docs>

<config lang="json">
{
    "name": "upload-panel",
    "type": "window",
    "tags": [],
    "ui": "",
    "version": "0.1.0",
    "cover": "",
    "description": "[TODO: describe this plugin with one sentence.]",
    "icon": "extension",
    "inputs": null,
    "outputs": null,
    "api_version": "0.1.8",
    "env": "",
    "permissions": [],
    "requirements": [
        "https://cdn.tailwindcss.com",
        "https://cdn.jsdelivr.net/npm/imjoy-rpc@0.5.6/dist/hypha-rpc-websocket.min.js"
    ],
    "dependencies": ["http://127.0.0.1:8000/viewer.imjoy.html"]
}
</config>

<script lang="javascript">

class ImJoyPlugin {
    async setup() {
        console.log("setup")
        await this.setupBioengine()
        await this.setupEvents()
    }

    async setupBioengine() {
        const server = await hyphaWebsocketClient.connectToServer({
            "name": "client",
            "server_url": "https://ai.imjoy.io",
            "method_timeout": 30
        })
        const triton = await server.getService("triton-client")
        console.log("Triton service:", triton)
        this.triton = triton
    }

    async setupEvents() {
        const viewer_plugin = await api.getPlugin('viewer')
        this.viewer_plugin = viewer_plugin
        const fileInput = document.getElementById("file-input")
        const fileChosen = document.getElementById('file-chosen');
        const viewImageByBytes = this.viewImageByBytes.bind(this)
        const viewImageByURL = this.viewImageByURL.bind(this)

        fileInput.addEventListener("input", async () => {
            const file = fileInput.files[0]
            fileChosen.textContent = file.name
            if (!file) {
                await api.alert("No file selected")
                return
            }
            const reader = new FileReader()
            reader.onload = async function() {
                await api.log("viewer plugin loaded")
                const content = this.result
                await viewImageByBytes(file.name, content)
                // set to empty so that the same file can be loaded again
                fileInput.value = ''
            }
            reader.readAsArrayBuffer(file)
        })

        const urlInput = document.getElementById("url-input")
        const urlLoadButton = document.getElementById("url-load-button")
        urlLoadButton.addEventListener("click", async () => {
            const url = urlInput.value
            if (!url) {
                await api.alert("No URL provided")
                return
            }
            await viewImageByURL(url)
        })

    }

    async viewImageByBytes(fileName, bytes) {
        this.bytes_data = bytes
        console.log(bytes)
        this.viewer_plugin.load_image_from_bytes(fileName, bytes)
    }

    async viewImageByURL(url) {
        this.url = url
        const fileName = url.split("?")[0]
          .replace(/\/$/, '')
          .split("/")
          .pop();

        if (fileName.endsWith(".zarr")) {
            await this.viewer_plugin.show_image_avivator(url)
        } else {
            const bytes = await this.loadBytesFromURL(url)
            this.bytes_data = bytes
            this.viewer_plugin.load_image_from_bytes(fileName, bytes)
        }
    }

    async loadBytesFromURL(url) {
        console.log("loading bytes from url", url)
        const response = await fetch(url)
        const bytes = await response.arrayBuffer()
        console.log(bytes)
        return bytes
    }

    async getModelRDF(model_id) {
        const ret = await this.triton.execute(
            [{
                "model_id": model_id,
                "inputs": null,
                "return_rdf": true,
                "weight_format": null
            }],
            "bioengine-model-runner",
            "imjoy",
        )
        console.log(ret)
        const result = ret.result
        const rdf = result.rdf
        return rdf
    }

    async run(ctx) {
        console.log("run", ctx)
        const defaultModel = "10.5281/zenodo.5874741"
        const model_id = ctx.data.id || defaultModel
        const rdf = await this.getModelRDF(model_id)
    }
}

api.export(new ImJoyPlugin())
</script>

<window lang="html">
<div class="m-1">
    <p class="mt-4">Load an PNG, JPG or TIFF file:</p>
    <div class="flex">
      <span id="file-chosen" class="w-1/2 px-4 py-2 border border-gray-300 rounded-l-md text-gray-500">No file selected.</span>
      <label for="file-input" class="py-2 px-3 bg-blue-500 text-white rounded-r-md cursor-pointer w-20 text-center">
        Browse
      </label>
      <input type="file" id="file-input" class="hidden" />
    </div>

    <p class="mt-4">Or load from an URL. The URL to OME-Zarr are supported:</p>
    <div class="flex">
      <input type="text" class="w-1/2 px-4 py-2 border border-gray-300 rounded-l-md text-gray-500"
        placeholder="Target URL"
        id="url-input" />
      <button
        class="px-4 py-2 bg-blue-500 text-white rounded-r-md w-20"
        id="url-load-button">Load</button>
    </div>
</div>
</window>
